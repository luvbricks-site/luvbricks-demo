generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

/* =========================
   Accounts / Auth
   ========================= */

model User {
  id            String   @id @default(cuid())
  email         String   @unique
  // Keep your existing name field (you can treat it as first name)
  name          String?
  // Add firstName to match components that expect it; you can fill either.
  firstName     String?
  passwordHash  String?     // null until you enable real passwords
  analyticsOptIn Boolean    @default(true)

  // Keep your existing points; used for the header badge and account page.
  points        Int       @default(0)

  // Relations
  orders        Order[]
  addresses     Address[]
  sessions      Session[]
  ledger        PointsLedger[]

  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt
}

model Session {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  token      String   @unique        // random string; store hash if you prefer
  createdAt  DateTime @default(now())
  expiresAt  DateTime
}

model Address {
  id         String   @id @default(cuid())
  userId     String
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  name       String
  line1      String
  line2      String?
  city       String
  state      String
  zip        String
  isDefault  Boolean  @default(false)
}

/* =========================
   Orders (extend your model)
   ========================= */

model Order {
  id             String   @id @default(cuid())
  userId         String?
  user           User?    @relation(fields: [userId], references: [id])

  // Your existing financials
  subtotalMsrp   Int
  bundleDiscount Int      @default(0) // order-level, MAP-safe
  totalCents     Int
  awardedPoints  Int      @default(0)

  // Add fields needed by the account UI
  number         String?  @unique
  status         String   @default("Processing") // "Processing" | "Shipped" | "Delivered" | ...
  trackingUrl    String?

  createdAt      DateTime @default(now())
}

/* =========================
   Catalog
   ========================= */

enum StockStatus {
  IN_STOCK
  LOW
  OUT_OF_STOCK
  PREORDER
}

model Theme {
  id        String    @id @default(cuid())
  slug      String    @unique
  name      String    @unique
  products  Product[]
  createdAt DateTime  @default(now())
  updatedAt DateTime  @updatedAt
}

model Product {
  id          String         @id @default(cuid())
  slug        String         @unique
  setNumber   Int            @unique
  name        String
  description String         @default("")
  themeId     String
  theme       Theme          @relation(fields: [themeId], references: [id])
  msrpCents   Int
  ageMin      Int?
  ageMax      Int?
  pieces      Int?
  isActive    Boolean        @default(true)
  images      ProductImage[]
  inventory   Inventory[]
  createdAt   DateTime       @default(now())
  updatedAt   DateTime       @updatedAt

  @@index([themeId])
  @@index([isActive])
}

model ProductImage {
  id        String  @id @default(cuid())
  productId String
  product   Product @relation(fields: [productId], references: [id])
  url       String
  alt       String  @default("")
  sortOrder Int     @default(0)

  @@index([productId])
  @@index([sortOrder])
}

model Inventory {
  id          String      @id @default(cuid())
  productId   String
  product     Product     @relation(fields: [productId], references: [id])
  sku         String      @unique
  qty         Int         @default(0)
  stockStatus StockStatus @default(OUT_OF_STOCK)

  @@index([productId])
}

/* =========================
   Set Requests (your existing block)
   ========================= */

model SetRequest {
  id             String   @id @default(cuid())
  setNumber      Int
  name           String
  theme          String?
  msrpCents      Int
  tier           Int
  casePack       Int?
  source         String // 'poll' | 'open'
  status         String // 'collecting' | 'incoming' | 'fulfilled' | 'archived'
  thresholdVotes Int
  thresholdDepos Int
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  supports SetSupport[]
}

model SetSupport {
  id           String    @id @default(cuid())
  setRequestId String
  userToken    String    // lightweight identity
  type         String    // 'vote' | 'deposit'
  amountCents  Int?
  createdAt    DateTime  @default(now())
  refundedAt   DateTime?

  request SetRequest @relation(fields: [setRequestId], references: [id])

  @@unique([setRequestId, userToken, type])
}

/* =========================
   Rewards (your existing block, now related to User)
   ========================= */

model RewardRule {
  id            String   @id @default(cuid())
  action        String   @unique   // e.g. 'social_follow_instagram'
  points        Int
  cooldownHours Int      @default(0)
  maxPerUser    Int      @default(1) // 1 = one-time action
  verification  String   @default("manual") // 'webhook' | 'oauth' | 'manual'
  createdAt     DateTime @default(now())
}

model PointsLedger {
  id        String   @id @default(cuid())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  action    String   // same as rule.action
  points    Int
  sourceId  String?  // e.g. orderId, webhook id
  uniqueKey String?  @unique // for idempotency
  status    String   @default("posted") // 'pending' | 'posted' | 'void'
  createdAt DateTime @default(now())

  @@index([userId, action])
}
